<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="img/evo-uci.png?v=3" type="image/png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <title>Gemini Evoluci√≥n de Enfermer√≠a</title>
    <link rel="stylesheet" href="styles.css">


    
    <style>
      :root {
        --fuente: #2e2925;
        --pantone: #368f3f;
        --principal: #92c99b;
        --hover: #d9ebd8;
        --borde: #4fa66a;
        --pantone15: #79b47f;
        --btn: #489950;
      }
      * {
        margin: 0;
        padding: 0;
        outline: none;
        box-sizing: border-box;
      }

      body {
        font-family: "Montserrat", sans-serif;
        margin: 20px;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: var(--principal);
      }

      h1 {
        text-align: center;
        margin-bottom: 20px;
        font-size: 24px;
        color: var(--fuente);
      }

      .box-selector {
  justify-content: center;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 20px;
}
.box-selector button {
  flex: 0 0 auto;       /* Que no estiren ni encojan */
  margin: 4px;          /* Espaciado uniforme */
}


      .box-selector button {
        padding: 10px 15px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        background-color: var(--pantone15);
        color: white;
        min-width: 80px;
      }

      .box-selector button:hover {
        background-color: white;
        color: var(--fuente);
        transition: all 0.5s ease;
      }

      .box-selector button.active {
        background-color: var(--pantone);
        box-shadow: 0 0 5px #0000004d;
        transition: all 0.5s ease;
      }

      .formulario {
        width: 100%;
        max-width: 600px;
        margin-bottom: 20px;
      }

      .campo {
        margin-bottom: 15px;
        text-align: center;
      }

      .campo label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
        color: var(--fuente);
      }

      .campo textarea {
        width: 95%;
        min-height: 80px;
        padding: 10px;
        font-size: 14px;
        border: 1px solid var(--borde);
        border-radius: 5px;
        resize: vertical;
        background-color: #d1e5d3;
        color: var(--fuente);
        outline: none;
        overflow: auto;
        overflow-y: hidden;
      }

      .campo textarea:disabled {
        background-color: var(--principal) !important;
        border: 1px solid var(--borde) !important;
        color: #6c757d !important;
        cursor: not-allowed;
      }

      .contador-global {
        text-align: right;
        font-weight: 400;
        font-size: 10px;
        color: var(--fuente);
        margin-top: -10px;
        margin-bottom: 10px;
      }

      /* Contenedores de botones principales y de imprimir */
      .main-actions-container,
      .print-actions-container {
        display: flex;
        justify-content: center; /* Centra los botones */
        margin-top: 20px;
        flex-wrap: wrap;
        gap: 10px;
        width: 100%;
        max-width: 600px; /* Ancho de referencia */
      }

      .main-actions-container button,
      .print-actions-container button,
      .print-actions-container .btn-alternativo {
        padding: 10px 15px;
        font-size: 14px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        background-color: var(--btn);
        color: #fff;
        flex: 1; /* Permite que los botones crezcan y se encojan */
        min-width: 120px; /* M√≠nimo para evitar que se hagan demasiado peque√±os */
        font-weight: bold;
        transition: background-color 0.3s ease-in-out;
      }

      .main-actions-container button:hover,
      .print-actions-container button:hover,
      .print-actions-container .btn-alternativo:hover {
        background-color: var(--pantone15);
        color: var(--fuente);
      }

      .print-actions-container .btn-alternativo {
        background-color: white;
        color: var(--pantone);
      }

      /* Estilo para los iconos dentro de los botones en pantallas grandes */
      .main-actions-container button i,
      .print-actions-container button i,
      .eliminar-buttons-row .eliminarInforme i,
      .copiar-btn i {
        font-size: 16px; /* Tama√±o peque√±o para los iconos en desktop */
        margin-right: 8px; /* Espacio entre icono y texto */
      }

      .resultado {
        margin-top: 20px;
        padding: 20px;
        font-family: "Montserrat", sans-serif;
        font-size: 12px;
        line-height: 1.6;
        display: none;
        background-color: #f5f5f5;
        width: 100%;
        max-width: 700px;
        box-sizing: border-box;
        word-wrap: break-word;
        white-space: pre-wrap;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .resultado p {
        margin: 8px 0;
      }

      .no-especificado {
        font-style: italic;
        color: #666;
      }

      #mensaje-box-seleccionado {
        text-align: center;
        font-weight: bold;
        margin-top: 5px;
        margin-bottom: 20px;
        color: var(--pantone);
        display: none;
        font-size: 20px;
      }

      #mensaje-turno {
        text-align: center;
        font-weight: bold;
        margin-top: 10px;
        color: var(--fuente);
        display: none;
        font-size: 14px;
      }
      /* Estilo para el mensaje de confirmaci√≥n temporal */
      #mensajeConfirmacion {
        text-align: center;
        padding: 10px;
        margin-top: 10px;
        background-color: #d4edda; /* Verde claro */
        color: #155724; /* Verde oscuro */
        border: 1px solid  #c3e6cb;
        border-radius: 5px;
        font-weight: bold;
        display: none; /* Oculto por defecto */
        width: 100%;
        max-width: 600px;
        box-sizing: border-box;
      }

      /* Contenedor principal de las filas de select/botones de eliminar */
      .fecha-container {
        font-weight: bold;
        margin-top: 20px; /* Separaci√≥n con los botones de arriba */
        color: var(--fuente);
        position: relative;
        overflow: visible !important;
        z-index: 1000;
        display: flex;
        flex-direction: column; /* Apila las filas verticalmente */
        align-items: center; /* Centra las filas horizontalmente */
        gap: 10px; /* Espacio vertical entre las filas */
        width: 100%;
        max-width: 600px; /* Alineado con el formulario y el grupo de botones principal */
      }

      /* Fila para el selector "Seleccionar Informe Guardado" */
      .select-row {
        display: flex;
        justify-content: center; /* Centra el selector */
        align-items: center; /* Alinea los elementos verticalmente */
        width: 100%;
        max-width: 600px; /* Mismo ancho que el contenedor principal de botones */
        gap: 8px; /* Espacio entre el icono y el select */
      }

      /* Contenedor para los dos botones de eliminar */
      .eliminar-buttons-row {
        display: flex;
        flex-direction: row; /* Coloca los botones en fila */
        justify-content: center; /* Centra los botones horizontalmente */
        gap: 10px; /* Espacio entre los botones */
        width: 100%;
        max-width: 600px; /* Mismo ancho que el contenedor principal de botones */
        flex-wrap: wrap; /* Permite que los botones se envuelvan en pantallas peque√±as */
      }

      /* Estilo para el select y los botones de eliminar (sin margin en los lados) */
      #informesGuardados,
      .eliminar-buttons-row .eliminarInforme {
        padding: 10px 15px;
        font-size: 14px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        background-color: var(--pantone15); /* Color de fondo consistente */
        color: var(--fuente); /* Color de texto consistente */
        flex: 1; /* Permite que los elementos crezcan y se encojan */
        min-width: 140px; /* Un m√≠nimo para que no se hagan demasiado peque√±os */
        font-weight: bold;
        transition: background-color 0.3s ease-in-out;
        margin: 0; /* Eliminar m√°rgenes laterales para que 'gap' funcione */
      }

      #informesGuardados:hover,
      .eliminar-buttons-row .eliminarInforme:hover {
        background-color: var(--btn); /* Hover consistente */
        color: #fff; /* Color de texto en hover consistente */
      }
      /* mensaje de aviso 1200 caracteres */
      #aviso-1200 {
        position: sticky;
        top: 50%;
        z-index: 100;
        background-color: #ffefc1;
        color: #b35900;
        font-weight: bold;
        padding: 10px 15px;
        margin-top: 10px;
        border-left: 5px solid #ffcc00;
        border-radius: 4px;
        font-size: 13px;
        animation: fadeIn 0.5s ease-in-out;
        text-align: center;
        max-width: 600px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .contador-aviso {
        color: var(--pantone) !important;
      }

      .contador-alerta {
        color: red !important;
        font-size: 14px;
      }

      /* bot√≥n copiar informe */
      .copiar-btn {
        padding: 10px 15px;
        font-size: 14px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        background-color: var(--btn);
        color: white;
        font-weight: bold;
        transition: background-color 0.3s ease-in-out;
        margin-top: 10px;
        min-width: 120px;
      }

      .copiar-btn:hover {
        background-color: var(--pantone15);
      }

      /* listado informes guardados */
      /* NOTA: #informesGuardados directas son menos efectivas con Choices.js */
      #informesGuardados optgroup {
        font-weight: bold;
        line-height: 1.6;
        color: white;
        background-color: var(--pantone15);
        padding: 4px 12px;
      }

      #informesGuardados option {
        padding: 6px 12px;
        white-space: nowrap;
      }

      /* no especificado */
      .no-especificado {
        font-style: italic;
        color: #666; /* gris medio */
      }

      /* Estilo para el select nativo */
      #informesGuardados {
        /* Restablecer estilos de Choices.js que ya no son necesarios */
        -webkit-appearance: none; /* Elimina estilos nativos en Webkit */
        -moz-appearance: none; /* Elimina estilos nativos en Firefox */
        appearance: none; /* Elimina estilos nativos */
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%20viewBox%3D%220%200%20292.4%20292.4%22%3E%3Cpath%20fill%3D%22%232e2925%22%20d%3D%22M287%20197.9c-3.6%203.6-7.8%205.4-12.1%205.4s-8.5-1.8-12.1-5.4L146.2%2091.2%2029.6%20197.9c-3.6%203.6-7.8%205.4-12.1%205.4s-8.5-1.8-12.1-5.4c-7.2-7.2-7.2-18.4%200-25.6L134.1%206.5c7.2-7.2%2018.4-7.2%2025.6%200l108.7%20108.7c7.2%207.2%207.2%2018.4%200%2025.6z%22%2F%3E%3C%2Fsvg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 12px;
        padding-right: 30px; /* Espacio para la flecha */
        text-align: center; /* Centra el texto */
        text-align-last: center; /* Para IE/Edge */
        padding-left: 30px; /* Equilibra el padding derecho para centrar visualmente */
      }

      /* Cuando el select est√° abierto, la lista de opciones no tendr√° scroll */
      #informesGuardados:focus::-webkit-scrollbar,
      #informesGuardados:active::-webkit-scrollbar,
      #informesGuardados:hover::-webkit-scrollbar {
        width: 0;
        background: transparent; /* make scrollbar transparent */
      }
      /* Para Firefox */
      #informesGuardados {
        scrollbar-width: none; /* Firefox */
      }
      #informesGuardados option {
        white-space: normal; /* Permite que el texto se envuelva */
      }

      /* Estilo del icono para el select (ahora oculto por defecto) */
      .select-icon {
        font-size: 18px; /* Tama√±o del icono */
        color: var(--fuente); /* Color del icono */
        display: none; /* Ocultar por defecto */
      }

      /* icono_balance */
      .icono-container {
        position: relative;
        display: inline-block;
        width: 30px; /* Ajusta el tama√±o del icono */
        height: 30px;
        margin-bottom: 10px;
      }

      .icono {
        position: absolute;
        width: 100%;
        height: 100%;
        transition: opacity 0.5s ease-in-out; /* Transici√≥n suave */
      }

      /* Mostrar el icono verde por defecto */
      .icono.verde {
        opacity: 1;
      }

      /* Ocultar el icono azul por defecto */
      .icono.azul {
        opacity: 0;
      }

      /* Cuando se hace hover, la imagen verde desaparece y la azul aparece */
      .icono-container:hover .verde {
        opacity: 0;
      }

      .icono-container:hover .azul {
        opacity: 1;
      }

      /* Fin icono_balance */
      /* <!-- Bot√≥n de cerrar sesi√≥n --> */
      /* Estilo general para el bot√≥n de cerrar sesi√≥n */
      #logoutBtn {
        padding: 10px 15px;
        margin-top: 10px;
        font-size: 14px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        background-color: red;
        color: #fff;
        font-weight: bold;
        transition: background-color 0.3s ease-in-out;
      }

      #logoutBtn:hover {
        background-color: var(--principal);
        color: var(--fuente);
        border: 1px solid var(--pantone);
      }

      /* Oculta el texto en dispositivos m√≥viles */
      @media (max-width: 768px) {
        #logoutBtn {
          display: none;
        }
        /* #logoutBtn span {
    display: none; 
  }
  #logoutBtn i {
    font-size: 20px; 
  } */
      }
      /* =============================== */
      /* FOOTER */
      /* =============================== */

      footer {
        color: var(--fuente);
        font-size: 10px;
        font-weight: bold;
        text-align: center;
        padding: 5px 0px 0px;
        margin: 20px auto 0px;
        width: 100%;
        z-index: 50;
        border-top: 1px solid var(--pantone);
      }
      /* fin del footer */

      /* MEDIA QUERIES PARA RESPONSIVIDAD */
      @media (max-width: 768px) {
        /* Ocultar los botones de imprimir en m√≥vil */
        .print-actions-container {
          display: none;
        }

        /* Ocultar el bot√≥n de copiar informe en m√≥vil */
        #copiarInformeBtn {
          display: none !important; /* Se mantiene oculto en m√≥vil, !important para asegurar */
        }

        /* Contenedor de botones principales (Generar, Borrar) */
        .main-actions-container {
          flex-direction: row; /* Organizar en fila */
          justify-content: space-evenly; /* Espacio entre los elementos */
          width: 100%;
          max-width: 90%; /* Ajusta el ancho m√°ximo para m√≥viles */
          align-items: center; /* Centra los elementos verticalmente */
          gap: 20px; /* Espacio m√°s peque√±o entre botones en fila */
        }

        /* Contenedor de botones de eliminar */
        .eliminar-buttons-row {
          flex-direction: row; /* Ya est√° en fila, asegurar */
          justify-content: space-evenly; /* Espacio entre los elementos */
          width: 100%;
          max-width: 90%;
          align-items: center;
          gap: 20px; /* Espacio m√°s peque√±o entre botones en fila */
        }

        /* Ocultar el texto de los botones y mostrar solo los iconos */
        .main-actions-container button,
        .eliminar-buttons-row .eliminarInforme {
          text-indent: -9999px; /* Mueve el texto fuera de la vista */
          overflow: hidden; /* Oculta el texto que se desborda */
          white-space: nowrap; /* Evita que el texto se envuelva */
          padding: 10px; /* Ajusta el padding para centrar el icono */
          min-width: 50px; /* Haz los botones m√°s peque√±os */
          max-width: 60px; /* Limita el ancho para que sean m√°s cuadrados */
          display: flex; /* Usa flexbox para alinear icono y texto */
          align-items: center;
          justify-content: center; /* Centra el contenido horizontalmente */
        }

        /* Estilo para los iconos dentro de los botones en m√≥vil */
        .main-actions-container button i,
        .eliminar-buttons-row .eliminarInforme i {
          font-size: 20px; /* Tama√±o del icono */
          margin-right: 0; /* Elimina el margen a la derecha del icono ya que no hay texto */
          text-indent: 0; /* Asegura que el icono no se vea afectado por el text-indent del padre */
        }
        /* Ajuste espec√≠fico para el icono de "Imprimir en Turno Alternativo" si tiene dos iconos */
        .print-actions-container .btn-alternativo i:first-child {
          margin-right: 4px;
        }

        /* Disminuir tama√±o de fuente para el select de informes guardados en m√≥vil */
        #informesGuardados {
          font-size: 11px; /* Reduce el tama√±o de fuente del select */
        }
        #informesGuardados optgroup {
          font-size: 9px; /* Reduce el tama√±o de fuente de los grupos de opciones */
        }
        #informesGuardados option {
          font-size: 9px !important; /* Reduce el tama√±o de fuente de las opciones */
        }

        /* Asegura que el icono del select est√© oculto en m√≥vil */
        .select-icon {
          display: none;
        }
      }
      
      
      /* =============================== */
      /* MEDIA PRINT */
      /* =============================== */

       /* ESTILOS DE IMPRESI√ìN MEJORADOS */
   @media print {
       @page {
  size: A4 portrait;
  margin: 0;
}
  /* 1) oculta todo */
  body * {
    visibility: hidden !important;
  }

html, body {
    height: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
    overflow: hidden !important;
  }
  
  #resultado,
  #resultado * {
    visibility: visible !important;
  }
  
  #resultado {
    page-break-inside: avoid !important;
    page-break-after:  avoid !important;
    page-break-before: avoid !important;
    
    /* 3) Que no exceda los l√≠mites de la A4 */
    max-height: calc(297mm - 4cm) !important; /* 297mm alto de A4 menos 2cm top + 2cm bottom */
    overflow: hidden !important;
  }
  
  
  #resultado {
    position: absolute !important;
    left: 3cm !important;
    right: 0.5cm !important;
    padding: 0 !important;
    margin: 0 !important;
    background: white !important;
    box-shadow: none !important;
    border: none !important;
    line-height: 1.2 !important;
    box-sizing: border-box;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  #resultado p {
margin: 0.1em 0 !important;
    line-height: 1.2 !important;
  }
  /* 
  #resultado.diurno-print {
    top: 2cm !important;
    bottom: auto !important;
  }
  #resultado.nocturno-print {
    bottom: 2cm !important;
    top: auto !important;
  } */
  
  /* Posicionamiento exacto */
  #resultado.diurno-print {
    position: absolute !important;
    top: 2cm !important;
    left: 3cm !important;
    right: 0.5cm !important;
  }
  #resultado.nocturno-print {
    position: absolute !important;
    bottom: 2cm !important;
    left: 3cm !important;
    right: 0.5cm !important;
  }
}


    </style>
  </head>
  <body>
    <h1>Evoluci√≥n de Enfermer√≠a</h1>
    <div id="contenidoApp" style="display: none">
      <div class="box-selector" id="boxSelector"></div>

      <a
        href="https://jolejuma.es/balance"
        target="_blank"
        class="icono-container"
      >
        <img src="img/balance_verde.png" alt="Balance" class="icono verde" />
        <img src="img/balance_azul.png" alt="Balance Azul" class="icono azul" />
      </a>

      <div id="mensaje-box-seleccionado">
        Ha seleccionado el Box <span id="numero-box-seleccionado"></span>
      </div>

      <div id="mensajeConfirmacion"></div>
      <form class="formulario" id="formulario">
        <div class="campo">
          <label for="neurologico">1. NEUROL√ìGICO</label>
          <textarea
            id="neurologico"
            oninput="guardarDraftDiario()"
            disabled
          ></textarea>
        </div>
        <div class="campo">
          <label for="cardiovascular">2. CARDIOVASCULAR</label>
          <textarea
            id="cardiovascular"
            oninput="guardarDraftDiario()"
            disabled
          ></textarea>
        </div>
        <div class="campo">
          <label for="respiratorio">3. RESPIRATORIO</label>
          <textarea
            id="respiratorio"
            oninput="guardarDraftDiario()"
            disabled
          ></textarea>
        </div>
        <div class="campo">
          <label for="renal">4. RENAL</label>
          <textarea
            id="renal"
            oninput="guardarDraftDiario()"
            disabled
          ></textarea>
        </div>
        <div class="campo">
          <label for="gastrointestinal">5. GASTROINTESTINAL</label>
          <textarea
            id="gastrointestinal"
            oninput="guardarDraftDiario()"
            disabled
          ></textarea>
        </div>
        <div class="campo">
          <label for="nutricional">6. NUTRICIONAL/METAB√ìLICO</label>
          <textarea
            id="nutricional"
            oninput="guardarDraftDiario()"
            disabled
          ></textarea>
        </div>
        <div class="campo">
          <label for="termorregulacion">7. TERMORREGULACI√ìN</label>
          <textarea
            id="termorregulacion"
            oninput="guardarDraftDiario()"
            disabled
          ></textarea>
        </div>
        <div class="campo">
          <label for="piel">8. PIEL</label>
          <textarea
            id="piel"
            oninput="guardarDraftDiario()"
            disabled
          ></textarea>
        </div>
        <div class="campo">
          <label for="otros">9. OTROS</label>
          <textarea
            id="otros"
            oninput="guardarDraftDiario()"
            disabled
          ></textarea>
        </div>
        <div class="campo">
          <label for="especial">10. ESPECIAL VIGILANCIA</label>
          <textarea
            id="especial"
            oninput="guardarDraftDiario()"
            disabled
          ></textarea>
        </div>

        <div class="contador-global">
          <strong>Total de caracteres utilizados:</strong>
          <span id="contador-total">0</span> /
          <span id="total-maximo">1200</span>
        </div>
      </form>
      
      

      <div class="main-actions-container">
        <button onclick="generarInforme()">
          <i class="fas fa-file-export"></i> Generar Informe
        </button>
        <button onclick="borrarDatos()">
          <i class="fa-solid fa-arrows-turn-right fa-flip-horizontal"></i>
          Borrar Datos
        </button>
        <button
          id="copiarInformeBtn"
          onclick="copiarInforme()"
          class="copiar-btn"
          style="display: none"
        >
          <i class="fas fa-copy"></i> Copiar Informe
        </button>
      </div>

      <div class="print-actions-container">
        <button onclick="imprimirAuto()">
          <i class="fas fa-print"></i> Imprimir
        </button>
        <button class="btn-alternativo" onclick="imprimirAlternativo()">
          <i class="fas fa-print"></i>
          <i class="fas fa-exchange-alt"></i> Imprimir en Turno Alternativo
        </button>
      </div>

      <div class="fecha-container">
        <div class="select-row">
         <select id="informesGuardados" onchange="cargarInformeDesdeLista(this)">
  <option value="">-- Seleccionar Informe Guardado --</option>
</select>


        </div>
        <div class="eliminar-buttons-row">
          <button class="eliminarInforme" onclick="eliminarInforme()">
            <i class="fas fa-trash-can"></i> Eliminar Informe
          </button>
          <button class="eliminarInforme" onclick="eliminarInformesDeBox()">
            <i class="fas fa-broom"></i> Eliminar Informes del Box
          </button>
        </div>
      </div>

      <div class="resultado" id="resultado"></div>
      
      <!-- √°rea oculta que usaremos solo para imprimir -->
<div id="printArea" style="display:none"></div>


      <div id="mensaje-turno"></div>
      <!-- Bot√≥n de cerrar sesi√≥n -->
      <button id="logoutBtn" onclick="cerrarSesion()">
        <i class="fa-solid fa-lock"></i>
        <span>Cerrar sesi√≥n</span>
      </button>
      <footer>
        <p>
          &copy; 2025 Informe Evoluci√≥n Enfermer√≠a. Todos los derechos
          reservados.
          <br>C.G.Francisco Manuel--M.G.Jos√© Antonio--M.M. Francisco Javier<br>
        </p>

      </footer>
      </div>
          <!-- ==================   JS principal   ================== -->

      <script>
        let currentUserId = null; // Declaraci√≥n de la variable global currentUserId

document.addEventListener('DOMContentLoaded', async () => {
    const contenidoApp = document.getElementById("contenidoApp");
    currentUserId = sessionStorage.getItem('currentUserId'); // Obtener user_id de sessionStorage

    if (!currentUserId) {
        console.warn("Acceso denegado: Usuario no autenticado (no hay user_id en sessionStorage).");
        // Redirige al login, ajusta la ruta si es necesario.
        // Si app.html est√° en public_html/evolucion-uci/ y index.html en public_html/, entonces 'index.html' es correcto.
        window.location.href = "index.html";
        return;
    } else {
        console.log("Usuario autenticado. UID:", currentUserId);
        // Ahora, verifica la sesi√≥n con el backend PHP para asegurar que es v√°lida en el servidor
        try {
            const response = await fetch('check_session.php'); // Llama a tu PHP de verificaci√≥n de sesi√≥n
            const data = await response.json();

            if (data.authenticated && data.user_id == currentUserId) { // Confirmar que el user_id coincide
                await cargarListadoInformesGuardados();
                contenidoApp.style.display = "block"; // Mostrar contenido seguro
            } else {
                console.warn("Acceso denegado: Sesi√≥n no v√°lida en el backend o user_id no coincide.");
                sessionStorage.removeItem('currentUserId'); // Limpiar el user_id local
                window.location.href = "index.html"; // Redirige al login
            }
        } catch (error) {
            console.error("Error al verificar la sesi√≥n con el backend:", error);
            sessionStorage.removeItem('currentUserId'); // Limpiar el user_id local
            window.location.href = "index.html"; // Redirige al login en caso de error de red
        }
    }

    // --- El resto de tu l√≥gica `window.onload` original se mueve aqu√≠: ---
    deshabilitarCampos();

    const boxSelector = document.getElementById("boxSelector");
    if (!boxSelector) {
        console.error("No se encontr√≥ el selector de Boxes.");
        return;
    }
    for (let i = 1; i <= 12; i++) {
        const btn = document.createElement("button");
        btn.textContent = `Box ${i}`;
        btn.onclick = () => selectBox(i);
        boxSelector.appendChild(btn);
    }
    // --- Fin del contenido movido ---
});

        // Variables globales
        const hoy = new Date().toISOString().slice(0, 10);
        let selectedBox = null;
        // Ya no se necesita choicesSelect como variable global para la instancia de Choices.js

        const campos = [
          "neurologico",
          "cardiovascular",
          "respiratorio",
          "renal",
          "gastrointestinal",
          "nutricional",
          "termorregulacion",
          "piel",
          "otros",
          "especial",
        ];

        const originalLabelTexts = {
          neurologico: "1. NEUROL√ìGICO",
          cardiovascular: "2. CARDIOVASCULAR",
          respiratorio: "3. RESPIRATORIO",
          renal: "4. RENAL",
          gastrointestinal: "5. GASTROINTESTINAL",
          nutricional: "6. NUTRICIONAL/METAB√ìLICO",
          termorregulacion: "7. TERMORREGULACI√ìN",
          piel: "8. PIEL",
          otros: "9. OTROS",
          especial: "10. ESPECIAL VIGILANCIA",
        };

        const TOTAL_CARACTERES = 1200;

        // Global variable to hold the timeout ID for hiding the copy button
        let hideCopyButtonTimeout;

       async function guardarDraftDiario() {
  if (!selectedBox || !currentUserId) {
    console.warn("No se puede guardar el borrador: Box no seleccionado o usuario no autenticado.");
    return;
  }

  // 1) Recolectar datos de los campos
  const datos = {};
  campos.forEach((campo) => {
    datos[campo] = document.getElementById(campo).value || "";
  });
  datos.date = hoy;                    // fecha en formato YYYY-MM-DD
  datos.timestamp = new Date().toISOString();
  datos.box = selectedBox;

  try {
    // 2) Enviar a PHP
    const resp = await fetch("save_draft.php", {
      method: "POST",
      headers: { "Content-Type": "application/json; charset=utf-8" },
      body: JSON.stringify(datos),
    });

    // ‚Äî Zona de depuraci√≥n: inspecciona la respuesta bruta ‚Äî
    const text = await resp.text();
    console.log("üî¥ save_draft.php devolvi√≥:", text);
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      console.error("‚ùå JSON.parse fall√≥ en save_draft.php:", e);
      mostrarMensaje("Respuesta inv√°lida del servidor al guardar borrador. Revise la consola.");
      return;
    }
    // ‚Äî fin depuraci√≥n ‚Äî

    // 3) Comprobar resultado
    if (data.success) {
      console.log("Borrador diario guardado en PHP.");
    } else {
      console.error("Error al guardar el borrador diario en PHP:", data.message);
      mostrarMensaje("Error al guardar el borrador diario. Intente de nuevo.");
    }
  } catch (e) {
    console.error("Error de red al guardar el borrador diario:", e);
    mostrarMensaje("Error de conexi√≥n al guardar el borrador diario. Intente de nuevo.");
    return;
  }

  // 4) Actualizar contador de caracteres y ocultar bot√≥n de copiar
  actualizarContadorGlobal();
  const copiarBtn = document.getElementById("copiarInformeBtn");
  if (copiarBtn) copiarBtn.style.display = "none";
}


      async function cargarDatos() {
  if (!selectedBox) return;
  try {
const resp = await fetch(`load_draft.php?box=${selectedBox}&date=${hoy}`);
    if (!resp.ok) throw new Error(resp.status);
    const data = await resp.json();
    if (data.success && data.draft) {
      campos.forEach(c => document.getElementById(c).value = data.draft[c]||'');
    } else {
      campos.forEach(c => document.getElementById(c).value = '');
    }
    actualizarContadorGlobal();
  } catch (err) {
    console.error('Error de red al cargar el borrador:', err);
    alert('Error al cargar los datos del borrador. Revise la consola.');
  }
}



  // -------------------------
// 1) Cargar informe existente
// -------------------------
async function cargarInformeDesdeLista(selectElement) {
  const val = selectElement.value;
  if (!val) return;

  const { box, fecha } = JSON.parse(val);
  // Petici√≥n al servidor
  const resp = await fetch(`load_report.php?box=${box}&fecha=${encodeURIComponent(fecha)}`);
  if (!resp.ok) {
    mostrarMensaje("Error al cargar informe");
    return;
  }
  const data = await resp.json();
  if (!data.success) {
    mostrarMensaje(data.message || "Error al cargar informe");
    return;
  }

  // 1) Rellenar textarea y contador
  campos.forEach(campo => {
    document.getElementById(campo).value = data.report[campo] || "";
  });
  actualizarContadorGlobal();

  // 2) Indicar box seleccionado
  selectedBox = box;
  document.getElementById("numero-box-seleccionado").textContent = box;
  document.getElementById("mensaje-box-seleccionado").style.display = "block";
  document
    .querySelectorAll(".box-selector button")
    .forEach(b => b.classList.remove("active"));
  document
    .querySelector(`.box-selector button:nth-child(${box})`)
    .classList.add("active");

  // 3) Renderizar informe en #resultado
  const ahora = new Date().getHours();
  const esDiurno = ahora >= 8 && ahora < 20;
  const turnoTexto = esDiurno
    ? "Turno de 8 a 20 horas"
    : "Turno de 20 a 8 horas";

  const resultadoDiv = document.getElementById("resultado");
  resultadoDiv.innerHTML =
    `<p><strong>BOX ${box} - ${turnoTexto}</strong></p>` +
    campos
      .map(c => {
        const label = originalLabelTexts[c].split(" ")[1];
        const val = data.report[c]
          ? data.report[c].replace(/\n/g, "<br>")
          : `<span class="no-especificado">No especificado</span>`;
        return `<p><strong>${label}:</strong><br>${val}</p>`;
      })
      .join("");

  resultadoDiv.classList.remove("diurno-print", "nocturno-print");
  resultadoDiv.classList.add(esDiurno ? "diurno-print" : "nocturno-print");
  resultadoDiv.style.display = "block";

  // 4) Mostrar bot√≥n copiar
  const copiarBtn = document.getElementById("copiarInformeBtn");
  copiarBtn.style.display = "inline-block";
  copiarBtn.disabled = false;
}


// -------------------------
// 2) Generar (o actualizar) informe
// -------------------------
async function generarInforme() {
  // a) Validaciones
  if (!selectedBox) {
    mostrarMensaje("Por favor, seleccione un Box antes de generar el informe.");
    return;
  }
  if (!currentUserId) {
    mostrarMensaje("Usuario no autenticado.");
    return;
  }

  // b) Recoger datos del formulario
  const datos = {};
  campos.forEach(campo => {
    datos[campo] = document.getElementById(campo).value || "";
  });
  // al menos un campo con contenido
  if (!campos.some(c => datos[c].trim() !== "")) {
    mostrarMensaje("El informe est√° vac√≠o. Rellene al menos un campo.");
    return;
  }

  datos.box = selectedBox;
  datos.fecha = hoy;                         // 'YYYY-MM-DD'
  datos.timestamp = new Date().toISOString(); // ISO timestamp

  try {
    // c) Env√≠o al servidor
    const resp = await fetch("save_report.php", {
      method: "POST",
      headers: { "Content-Type": "application/json; charset=utf-8" },
      body: JSON.stringify(datos),
    });
    if (!resp.ok) {
      mostrarMensaje("Error de servidor al guardar el informe. Intente de nuevo.");
      return;
    }
    const data = await resp.json();
    if (!data.success) {
      console.error("PHP dijo:", data.message);
      mostrarMensaje("No se pudo guardar el informe. Revise la consola.");
      return;
    }

    console.log("‚úÖ Informe guardado en PHP.");
    await cargarListadoInformesGuardados(); // refrescar listado

    // d) Confirmaci√≥n temporal
    const fechaHora = new Date(datos.timestamp).toLocaleDateString("es-ES", {
      year: "numeric", month: "2-digit", day: "2-digit",
      hour: "2-digit", minute: "2-digit", second: "2-digit",
    });
    mostrarMensajeTemporal(`Informe guardado: Box ${selectedBox} ‚Äì ${fechaHora}`);

    // e) Renderizar en #resultado (sin volver a guardar)
    const ahora = new Date().getHours();
    const esDiurno = ahora >= 8 && ahora < 20;
    const turnoTexto = esDiurno
      ? "Turno de 8 a 20 horas"
      : "Turno de 20 a 8 horas";

    const resultadoDiv = document.getElementById("resultado");
    resultadoDiv.innerHTML =
      `<p><strong>BOX ${selectedBox} ‚Äì ${turnoTexto}</strong></p>` +
      campos
        .map(c => {
          const val = datos[c].trim();
          const contenido = val === ""
            ? `<span class="no-especificado">No Especificado</span>`
            : val;
          const etiqueta = c === "especial"
            ? "ESPECIAL VIGILANCIA"
            : originalLabelTexts[c].split(" ")[1];
          return `<p><strong>${etiqueta}:</strong> ${contenido}</p>`;
        })
        .join("");

    resultadoDiv.classList.remove("diurno-print", "nocturno-print");
    resultadoDiv.classList.add(esDiurno ? "diurno-print" : "nocturno-print");
    resultadoDiv.style.display = "block";

    // Mensaje de turno
    const msgTurno = document.getElementById("mensaje-turno");
    msgTurno.textContent = `Turno seleccionado: ${turnoTexto}`;
    msgTurno.style.display = "block";

    // Mostrar copiar
    const copiarBtn = document.getElementById("copiarInformeBtn");
    if (window.innerWidth > 768) copiarBtn.style.display = "inline-block";
    copiarBtn.disabled = false;

  } catch (err) {
    console.error("‚ùå Error de red al generar y guardar el informe:", err);
    mostrarMensaje("Error de conexi√≥n al generar y guardar el informe. Intente de nuevo.");
  }
}



        function volcarDatosEnFormulario(report) {
  selectedBox = report.box;
  // 1) marcar bot√≥n activo
  document.querySelectorAll('.box-selector button')
    .forEach(b => b.classList.remove('active'));
  document.querySelector(`.box-selector button:nth-child(${selectedBox})`)
    .classList.add('active');
  // 2) mostrar el mensaje
  document.getElementById('numero-box-seleccionado').textContent = selectedBox;
  document.getElementById('mensaje-box-seleccionado').style.display = 'block';
  // 3) habilitar campos por si estaban deshabilitados
  habilitarCampos();
}


        function copiarInforme() {
          if (!selectedBox) return;

          const horaActual = new Date().getHours();
          const esTurnoDiurno = horaActual >= 8 && horaActual < 20;
          const turnoTexto = esTurnoDiurno
            ? "Turno de 8 a 20 horas"
            : "Turno de 20 a 8 horas";

          let texto = `BOX ${selectedBox} - ${turnoTexto}\n`;

          campos.forEach((campo) => {
            const valor =
              document.getElementById(campo).value.trim() || "No Especificado";
            const titulo =
              campo === "especial"
                ? "ESPECIAL VIGILANCIA"
                : originalLabelTexts[campo].substring(
                    originalLabelTexts[campo].indexOf(" ") + 1
                  );
            texto += `${titulo}: ${valor}\n`;
          });

          navigator.clipboard
            .writeText(texto)
            .then(() => {
              const boton = document.getElementById("copiarInformeBtn");
              boton.innerHTML = "‚úÖ Copiado";
              boton.disabled = true;

              // El bot√≥n se ocultar√° solo si se modifica un textarea, no autom√°ticamente
              setTimeout(() => {
                boton.innerHTML = '<i class="fas fa-copy"></i> Copiar Informe';
                boton.disabled = false;
              }, 2000); // Reset text after 2 seconds
            })
            .catch((err) => {
              console.error("Error al copiar el texto: ", err);
              // Fallback para navegadores que no soportan navigator.clipboard
              const textarea = document.createElement("textarea");
              textarea.value = texto;
              document.body.appendChild(textarea);
              textarea.select();
              document.execCommand("copy");
              document.body.removeChild(textarea);

              const boton = document.getElementById("copiarInformeBtn");
              boton.innerHTML = "‚úÖ Copiado (fallback)";
              boton.disabled = true;

              setTimeout(() => {
                boton.innerHTML = '<i class="fas fa-copy"></i> Copiar Informe';
                boton.disabled = false;
              }, 2000); // Reset text after 2 seconds
            });
        }
        
        function prepararImpresion(turnoTexto) {
  const pa = document.getElementById('printArea');
  pa.innerHTML = '';                                 // limpio
  pa.style.display = 'block';                        // lo muestro
  pa.innerHTML += `<h2>BOX ${selectedBox} ‚Äì ${turnoTexto}</h2>`;
  
  campos.forEach(campo => {
    const label = originalLabelTexts[campo].split(' ')[1];
    const valor = document.getElementById(campo).value.trim() || 'No especificado';
    // respetar saltos de l√≠nea
    pa.innerHTML += `<p><strong>${label}:</strong><br>${valor.replace(/\n/g,'<br>')}</p>`;
  });
}

function generarInformeParaImpresion(turnoTexto, clasePrint) {
  const resultadoDiv = document.getElementById('resultado');

  // *** Este fragmento NUNCA cambia: ***
  resultadoDiv.innerHTML =
    `<p><strong>BOX ${selectedBox} - ${turnoTexto}</strong></p>` +
    campos.map(campo => {
      const label = originalLabelTexts[campo].split(' ')[1];
      const val = document.getElementById(campo).value.trim() ||
                  '<span class="no-especificado">No especificado</span>';
return `<p><strong>${label}:</strong> ${val.replace(/\n/g,' ')}</p>`;
    }).join('');
  // ************************************

  resultadoDiv.classList.remove('diurno-print','nocturno-print');
  resultadoDiv.classList.add(clasePrint);
  resultadoDiv.style.display = 'block';
}

function imprimir(turnoTexto, esDiurno) {
  const resultadoDiv = document.getElementById('resultado');

  // 1) Generar el html
  resultadoDiv.innerHTML =
      `<p><strong>BOX ${selectedBox} - ${turnoTexto}</strong></p>` +
      campos.map(c => {
        const label = originalLabelTexts[c].split(' ')[1];
        const val = document.getElementById(c).value.trim()
                  || '<span class="no-especificado">No especificado</span>';
        return `<p><strong>${label}:</strong><br>${val.replace(/\n/g,'')}</p>`;
      }).join('');

  // 2) Mostrar el div
  resultadoDiv.style.display = 'block';

  // 3) Ajustar variable CSS seg√∫n turno
  if (esDiurno) {
    resultadoDiv.style.setProperty('--print-top', '2cm');
  } else {
    // para turno nocturno queremos 2cm desde el borde INFERIOR
    // calculamos un top grande: A4 son 29.7cm de alto, restamos 2cm y la altura del div.
    // como aproximaci√≥n, lo bajamos a ‚Äúauto‚Äù y usamos bottom:
    resultadoDiv.style.removeProperty('--print-top');
    resultadoDiv.style.bottom = '2cm';
    resultadoDiv.style.top = 'auto';
    resultadoDiv.style.position = 'absolute';
  }

  // 4) Llamar a print
  window.print();

  // 5) Ocultar de nuevo
  resultadoDiv.style.display = 'none';
}


function imprimirAuto() {
  if (!selectedBox) return mostrarMensaje('Seleccione un Box');
  const h = new Date().getHours();
  const esDiurno = h >= 8 && h < 20;
  const turnoTexto = esDiurno 
    ? 'Turno de 8 a 20 horas'
    : 'Turno de 20 a 8 horas';

  // 1) Creamos el contenido
  const div = document.getElementById('resultado');
  div.innerHTML =
    `<p><strong>BOX ${selectedBox} - ${turnoTexto}</strong></p>` +
    campos.map(c => {
      const label = originalLabelTexts[c].split(' ')[1];
      const val = document.getElementById(c).value.trim() || 'No especificado';
      // *** NUNCA cambia: etiqueta + espacio + valor ***
      return `<p><strong>${label}:</strong> ${val.replace(/\n/g,' ')}</p>`;
    }).join('');

  // 2) Posicionar seg√∫n turno
  div.classList.remove('diurno-print','nocturno-print');
  div.classList.add(esDiurno ? 'diurno-print' : 'nocturno-print');
  div.style.display = 'block';

  // 3) Disparar impresi√≥n
  window.print();

  // 4) Limpiar UI
  div.style.display = 'none';
}


function imprimirAlternativo() {
  if (!selectedBox) return mostrarMensaje('Seleccione un Box');

  // 1) Determinamos si ahora es turno diurno (8‚Äì20h)
  const hora = new Date().getHours();
  const esDiurno = hora >= 8 && hora < 20;

  // 2) Texto e inversi√≥n del turno
  const turnoTexto = esDiurno
    ? 'Turno de 20 a 8 horas'
    : 'Turno de 8 a 20 horas';

  // 3) Generamos el HTML id√©ntico a imprimirAuto(), pero con el turno alternativo
  const div = document.getElementById('resultado');
  div.innerHTML =
    `<p><strong>BOX ${selectedBox} - ${turnoTexto}</strong></p>` +
    campos.map(c => {
      const label = originalLabelTexts[c].split(' ')[1];
      const val = document.getElementById(c).value.trim() || 'No especificado';
      return `<p><strong>${label}:</strong> ${val.replace(/\n/g,' ')}</p>`;
    }).join('');

  // 4) Aplicamos la clase CSS adecuada (invertida respecto al d√≠a real)
  div.classList.remove('diurno-print','nocturno-print');
  // Si es diurno, imprimimos modo nocturno; si es nocturno, imprimimos modo diurno
  div.classList.add(esDiurno ? 'nocturno-print' : 'diurno-print');

  // 5) Mostramos el div y lanzamos la impresi√≥n
  div.style.display = 'block';
  window.print();

  // 6) Ocultamos de nuevo para no ensuciar la UI
  div.style.display = 'none';
}




        function deshabilitarCampos() {
          campos.forEach((campo) => {
            const textarea = document.getElementById(campo);
            const label = document.querySelector(`label[for="${campo}"]`);
            if (textarea) {
              textarea.disabled = true;
              textarea.placeholder = "Seleccione un Box primero";
            }
            if (label && originalLabelTexts[campo]) {
              label.textContent = originalLabelTexts[campo];
            }
          });
        }

        function habilitarCampos() {
          campos.forEach((campo) => {
            const textarea = document.getElementById(campo);
            const label = document.querySelector(`label[for="${campo}"]`);
            if (textarea) {
              textarea.disabled = false;
              textarea.placeholder = "";
            }
            if (label && originalLabelTexts[campo]) {
              label.textContent = `Box-${selectedBox} -- ${originalLabelTexts[campo]}`;
            }
          });
        }

        function actualizarContadorGlobal() {
          let total = 0;
          campos.forEach((campo) => {
            const valor = document.getElementById(campo)?.value || "";
            total += valor.length;
          });
          document.getElementById("contador-total").textContent = total;

          const div = document.querySelector(".contador-global");

          div.classList.remove("contador-aviso", "contador-alerta");

          if (total >= 1200) {
            if (!document.getElementById("aviso-1200")) {
              const aviso = document.createElement("div");
              aviso.id = "aviso-1200";
              aviso.innerHTML =
                "‚ö†Ô∏è <strong>ATENCI√ìN:</strong> Ha rellenado la mitad del documento.";
              const contenedorBox = document.getElementById("boxSelector");
              contenedorBox.insertAdjacentElement("afterend", aviso);
            }
          } else {
            const avisoExistente = document.getElementById("aviso-1200");
            if (avisoExistente) avisoExistente.remove();
          }

          return total;
        }

        function mostrarMensaje(mensaje) {
          alert(mensaje);
        }

        function mostrarMensajeTemporal(mensaje) {
          const mensajeDiv = document.getElementById("mensajeConfirmacion");
          if (mensajeDiv) {
            mensajeDiv.textContent = mensaje;
            mensajeDiv.style.display = "block";
            setTimeout(() => {
              mensajeDiv.style.display = "none";
              mensajeDiv.textContent = "";
            }, 4000);
          }
        }

        function selectBox(boxNumber) {
  selectedBox      = boxNumber;
  currentReportId  = null;
  loadedFromList   = false;
  cargarDatos();               // tu borrador de hoy, si lo hay
  habilitarCampos();
  document.getElementById("mensaje-box-seleccionado").style.display = "block";
          habilitarCampos();
        }


async function cargarListadoInformesGuardados() {
  if (!currentUserId) {
    console.warn("No se puede cargar el listado de informes: usuario no autenticado.");
    return;
  }

  const select = document.getElementById("informesGuardados");
  select.innerHTML = '<option value="">-- Seleccionar Informe Guardado --</option>';

  try {
    // 1) Fetch y debug
    const resp = await fetch('list_reports.php');
    const text = await resp.text();
    console.log("üëâ list_reports.php devolvi√≥:", text);
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      console.error("‚ùå JSON.parse fall√≥ en list_reports.php:", e);
      mostrarMensaje("Respuesta inv√°lida del servidor. Revise la consola.");
      return;
    }

    // 2) Procesamos la respuesta
    if (data.success && Array.isArray(data.reports)) {
      const informesPorBox = {};

      data.reports.forEach(report => {
        const box       = report.box;
        const timestamp = report.timestamp;
        const fecha     = report.fecha;
        // Agrupar por box
        if (!informesPorBox[box]) informesPorBox[box] = [];
        informesPorBox[box].push(report);
      });

      // 3) Ordenar boxes y sus informes
      Object.keys(informesPorBox)
        .map(Number)
        .sort((a, b) => a - b)
        .forEach(box => {
          const grupo = document.createElement("optgroup");
          grupo.label = `Box ${box}`;
          grupo.style.backgroundColor = "var(--pantone15)";
          grupo.style.color = "white";
          grupo.style.fontWeight = "bold";

          informesPorBox[box]
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
            .forEach(report => {
              const option    = document.createElement("option");
              const dateObj   = new Date(report.timestamp);
              const fechaHora = dateObj.toLocaleDateString("es-ES", {
                year:   "numeric",
                month:  "2-digit",
                day:    "2-digit",
                hour:   "2-digit",
                minute: "2-digit",
                second: "2-digit",
              });
              // 4) Incluir id, box y fecha en el value
              option.value = JSON.stringify({
                id:    report.id,
                box:   report.box,
                fecha: report.fecha
              });
              option.textContent = `Box ${box} - ${fechaHora}`;
              grupo.appendChild(option);
            });

          select.appendChild(grupo);
        });

      console.log("Listado de informes guardados cargado desde PHP.");
    } else {
      console.error("Error en list_reports.php:", data.message);
      mostrarMensaje("Error al cargar el listado de informes guardados.");
    }
  } catch (error) {
    console.error("Error de red al cargar el listado de informes guardados:", error);
    mostrarMensaje("Error de conexi√≥n al cargar el listado de informes guardados.");
  }
}
      



function mostrarInformeEnPantalla(datos) {
  const horaActual   = new Date().getHours();
  const esDiurno     = horaActual >= 8 && horaActual < 20;
  const turnoTexto   = esDiurno
    ? "Turno de 8 a 20 horas"
    : "Turno de 20 a 8 horas";
  const resultadoDiv = document.getElementById("resultado");

  resultadoDiv.innerHTML =
    `<p><strong>BOX ${selectedBox} ‚Äì ${turnoTexto}</strong></p>` +
    campos.map(c => {
      const val = datos[c].trim() || "<span class='no-especificado'>No especificado</span>";
      const etiqueta = c === "especial"
        ? "ESPECIAL VIGILANCIA"
        : originalLabelTexts[c].split(" ")[1];
      return `<p><strong>${etiqueta}:</strong> ${val}</p>`;
    }).join("");

  resultadoDiv.classList.remove("diurno-print","nocturno-print");
  resultadoDiv.classList.add(esDiurno ? "diurno-print":"nocturno-print");
  resultadoDiv.style.display = "block";

  // Mostrar bot√≥n copiar
  const btn = document.getElementById("copiarInformeBtn");
  if (window.innerWidth > 768) btn.style.display = "inline-block";
  btn.disabled = false;
}


       async function eliminarInforme() {
    const selectElement = document.getElementById("informesGuardados");
    const valueString = selectElement.value; // Obtener el string JSON del valor
    const informeLabel =
        selectElement.options[selectElement.selectedIndex]?.textContent;

    if (!valueString) {
        mostrarMensaje(
            "Por favor, seleccione un informe guardado para eliminar."
        );
        return;
    }
    if (!currentUserId) {
        mostrarMensaje("Usuario no autenticado para eliminar informe.");
        return;
    }

    const params = JSON.parse(valueString); // Parsear el string JSON a un objeto
    const boxToDelete = params.box;
    const fechaToDelete = params.fecha;

    if (
        !confirm(
            `¬øEst√°s seguro de que quieres eliminar el informe "${informeLabel}"?`
        )
    ) {
        return;
    }

    try {
        const response = await fetch('delete_reports.php',{
  method:'POST',
  headers:{'Content-Type':'application/json; charset=utf-8'},
  body: JSON.stringify({ box:boxToDelete, fecha:fechaToDelete })
});

        const data = await response.json();

        if (data.success) {
            mostrarMensajeTemporal(
                `Informe "${informeLabel}" eliminado exitosamente.`
            );
            cargarListadoInformesGuardados(); // Recargar la lista
            // Tambi√©n podr√≠as limpiar los campos si el informe eliminado era el actualmente cargado
            if (selectedBox === boxToDelete && hoy === fechaToDelete) {
                campos.forEach(campo => document.getElementById(campo).value = "");
                actualizarContadorGlobal();
            }
        } else {
            console.error("Error al eliminar el informe en PHP:", data.message);
            mostrarMensaje(data.message || "Error al eliminar el informe. Int√©ntalo de nuevo.");
        }
    } catch (error) {
        console.error("Error de red al eliminar el informe:", error);
        mostrarMensaje("Error de conexi√≥n al eliminar el informe. Int√©ntalo de nuevo.");
    }
}


        async function eliminarInformesDeBox() {
    if (!selectedBox) {
        mostrarMensaje(
            "Por favor, seleccione un Box primero para eliminar sus informes."
        );
        return;
    }
    if (!currentUserId) {
        mostrarMensaje("Usuario no autenticado para eliminar informes del Box.");
        return;
    }

    if (
        !confirm(
            `¬øEst√°s seguro de que quieres eliminar TODOS los informes guardados del Box ${selectedBox}? Esta acci√≥n es irreversible.`
        )
    ) {
        return;
    }

    try {
        const response = await fetch('delete_reports.php',{
  method:'POST',
  headers:{'Content-Type':'application/json; charset=utf-8'},
  body: JSON.stringify({ box:selectedBox })
});

        const data = await response.json();

        if (data.success) {
            mostrarMensajeTemporal(data.message); // El PHP ya devuelve un mensaje detallado
            cargarListadoInformesGuardados(); // Recargar la lista
            campos.forEach(
                (campo) => (document.getElementById(campo).value = "")
            );
            actualizarContadorGlobal();
        } else {
            console.error("Error al eliminar informes del Box en PHP:", data.message);
            mostrarMensaje(data.message || "Error al eliminar informes del Box. Int√©ntalo de nuevo.");
        }
    } catch (error) {
        console.error("Error de red al eliminar informes del Box:", error);
        mostrarMensaje(
            "Error de conexi√≥n al eliminar informes del Box. Int√©ntalo de nuevo."
        );
    }
}


        
        async function cerrarSesion() {
  try {
    const resp = await fetch('logout.php', { method:'POST' });
    const data = await resp.json();
    if (data.success) {
      sessionStorage.removeItem('currentUserId');
      window.location.href = 'index.html';
    } else {
      mostrarMensaje('Error al cerrar sesi√≥n.');
    }
  } catch {
    mostrarMensaje('Error de red al cerrar sesi√≥n.');
  }
}



async function cargarBorrador(box){
    const r = await fetch(`load_draft.php?box=${box}`);
    if(!r.ok) throw new Error(r.status);
    const data = await r.json();          // ‚Üê ahora SIEMPRE es JSON

}


       
      </script>
    <script src="informes.js"></script>

    <!-- Fin de contenidoApp -->
  </body>
</html>
